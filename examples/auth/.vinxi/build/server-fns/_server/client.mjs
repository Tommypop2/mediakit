import{getRequestEvent as k,isServer as d,createComponent as U}from"solid-js/web";import{createContext as y,useContext as A,createSignal as E,onMount as P}from"solid-js";import{b as h,p as $,c as b}from"./auth.mjs";const g=y(void 0),O=()=>{const t=A(g);if(!t)throw new Error("[@solid-mediakit/auth]: `useAuth` must be wrapped in a <SessionProvider />");return{signIn:async(e,n,r)=>await C(t.authAction,e,n,r),signOut:async e=>await x(t.authAction,e),status:()=>t.sessionState().status,session:()=>t.sessionState().data}},v=t=>t.locals?.session?t.locals.session:t.nativeEvent?.context?.session;function H(t){let s=!1;const a=k(),e=d?v(a):void 0;e!==void 0&&(console.log("setting R"),s=!0);const[n,r]=E(e===null?{status:"unauthenticated",data:null}:e?{status:"authenticated",data:e}:{status:"loading",data:void 0}),c=async()=>{try{const o=await T(a);return o?{status:"authenticated",data:o}:{status:"unauthenticated",data:null}}catch(o){return console.error("@auth",o),{status:"unauthenticated",data:null}}},i=async o=>{o&&n().status!=="loading"&&!t.refetchAfterServer||r(await c())};return P(()=>{s||i(!0)}),U(g.Provider,{value:{sessionState:n,setSessionState:r,authAction:i},get children(){return t.children}})}const L=t=>typeof window>"u"?`${$(b("AUTH_URL_INTERNAL","AUTH_URL","VERCEL_URL")).origin}${t}`:t,T=async t=>{let s;if(d&&t?.request){const n=t.request.headers.get("cookie");n&&(s={headers:{cookie:n}})}const a=await fetch(L(`${h()}/session`),s);if(d&&t?.request&&t?.response){const n=a.headers.get("set-cookie");if(n)try{t.response.headers.append("set-cookie",n??"")}catch{}}const e=await a.json();if(!a.ok)throw new Error(e.error);return!e||Object.keys(e).length===0?null:e};async function C(t,s,a,e){const{callbackUrl:n=window.location.href,redirect:r=!0}=a??{},c=s==="credentials",o=c||s==="email",f=h(),S=`${`${f}/${c?"callback":"signin"}/${s}`}?${new URLSearchParams(e)}`,m=await fetch(`${f}/csrf`),{csrfToken:p}=await m.json(),l=await fetch(S,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Auth-Return-Redirect":"1"},body:new URLSearchParams({...a,csrfToken:p,callbackUrl:n})}),u=await l.clone().json();if(r||!o){window.location.href=u.url??n,u.url.includes("#")&&window.location.reload();return}const w=new URL(u.url).searchParams.get("error"),R=new URL(u.url).searchParams.get("code");return l.ok&&await t(),{error:w,code:R,status:l.status,ok:l.ok,url:w?null:u.url}}async function x(t,s){const{redirectTo:a=window.location.href}=s??{},e=h(),n=await fetch(`${e}/csrf`),{csrfToken:r}=await n.json(),i=await(await fetch(`${e}/signout`,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Auth-Return-Redirect":"1"},body:new URLSearchParams({csrfToken:r,callbackUrl:a})})).json();if(s?.redirect??!0){const o=i.url??a;window.location.href=o,o.includes("#")&&window.location.reload();return}return await t(),i}export{H as S,O as u};
