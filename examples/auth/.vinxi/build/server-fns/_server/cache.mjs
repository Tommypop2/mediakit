import{getRequestEvent as C,isServer as R}from"solid-js/web";import{provideRequestEvent as _e}from"solid-js/web/storage";import{H3Event as z,setResponseStatus as He,setHeader as Oe,appendResponseHeader as Te,getRequestIP as qe,getResponseStatus as Le,getResponseStatusText as $e,getCookie as ke,setCookie as Fe,getRequestURL as je,getResponseHeaders as Ie,getResponseHeader as Ue,setResponseHeader as We,removeResponseHeader as Me,getRequestWebStream as Be}from"h3";import{AsyncLocalStorage as De}from"node:async_hooks";import{getOwner as ie,runWithOwner as ue,createMemo as P,createContext as le,useContext as fe,createSignal as O,createRenderEffect as Ne,on as he,startTransition as W,resetErrorBoundaries as Ke,batch as ze,untrack as Ge,createComponent as Je,getListener as Xe,onCleanup as Qe,sharedConfig as S}from"solid-js";function Ve(t={}){let e,n=!1;const r=s=>{if(e&&e!==s)throw new Error("Context conflict")};let o;if(t.asyncContext){const s=t.AsyncLocalStorage||globalThis.AsyncLocalStorage;s?o=new s:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(o&&e===void 0){const s=o.getStore();if(s!==void 0)return s}return e};return{use:()=>{const s=a();if(s===void 0)throw new Error("Context is not available");return s},tryUse:()=>a(),set:(s,c)=>{c||r(s),e=s,n=!0},unset:()=>{e=void 0,n=!1},call:(s,c)=>{r(s),e=s;try{return o?o.run(s,c):c()}finally{n||(e=void 0)}},async callAsync(s,c){e=s;const f=()=>{e=s},d=()=>e===s?f:void 0;re.add(d);try{const u=o?o.run(s,c):c();return n||(e=void 0),await u}finally{re.delete(d)}}}}function Ye(t={}){const e={};return{get(n,r={}){return e[n]||(e[n]=Ve({...t,...r})),e[n],e[n]}}}const B=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},te="__unctx__",Ze=B[te]||(B[te]=Ye()),et=(t,e={})=>Ze.get(t,e),ne="__unctx_async_handlers__",re=B[ne]||(B[ne]=new Set);function tt(t,e,n){t.context[e]=n}function nt(t){let e;const n=pe(t),r={duplex:"half",method:t.method,headers:t.headers};return t.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:t.node.req.body}):new Request(n,{...r,get body(){return e||(e=ut(t),e)}})}function rt(t){return t.web??={request:nt(t),url:pe(t)},t.web.request}function ot(){return dt()}const de=Symbol("$HTTPEvent");function st(t){return typeof t=="object"&&(t instanceof z||t?.[de]instanceof z||t?.__is_event__===!0)}function v(t){return function(...e){let n=e[0];if(st(n))e[0]=n instanceof z||n.__is_event__?n:n[de];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=ot(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");e.unshift(n)}return t(...e)}}const pe=v(je),at=v(qe),oe=v(He),se=v(Le),ct=v($e),U=v(Ie),ae=v(Ue),it=v(We),ge=v(Te),Gt=v(ke),Jt=v(Fe),Xt=v(Oe),ut=v(Be),lt=v(Me),Qt=v(tt),ft=v(rt);function ht(){return et("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:De})}function dt(){return ht().use().event}const D="solidFetchEvent";function pt(t){return{request:ft(t),response:mt(t),clientAddress:at(t),locals:{},nativeEvent:t}}function gt(t){return{...t}}function Vt(t){if(!t.context[D]){const e=pt(t);t.context[D]=e}return t.context[D]}function Yt(t,e){for(const[n,r]of e.entries())ge(t,n,r)}class yt{event;constructor(e){this.event=e}get(e){const n=ae(this.event,e);return Array.isArray(n)?n.join(", "):n||null}has(e){return this.get(e)!==void 0}set(e,n){return it(this.event,e,n)}delete(e){return lt(this.event,e)}append(e,n){ge(this.event,e,n)}getSetCookie(){const e=ae(this.event,"Set-Cookie");return Array.isArray(e)?e:[e]}forEach(e){return Object.entries(U(this.event)).forEach(([n,r])=>e(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries(U(this.event)).map(([e,n])=>[e,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys(U(this.event))[Symbol.iterator]()}values(){return Object.values(U(this.event)).map(e=>Array.isArray(e)?e.join(", "):e)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function mt(t){return{get status(){return se(t)},set status(e){oe(t,e)},get statusText(){return ct(t)},set statusText(e){oe(t,se(t),e)},headers:new yt(t)}}function Zt(t,e,n){if(typeof t!="function")throw new Error("Export from a 'use server' module must be a function");const r="";return new Proxy(t,{get(o,a,s){return a==="url"?`${r}/_server?id=${encodeURIComponent(e)}&name=${encodeURIComponent(n)}`:a==="GET"?s:o[a]},apply(o,a,s){const c=C();if(!c)throw new Error("Cannot call server function outside of a request");const f=gt(c);return f.locals.serverFunctionMeta={id:e+"#"+n},f.serverOnly=!0,_e(f,()=>t.apply(a,s))}})}function wt(){let t=new Set;function e(o){return t.add(o),()=>t.delete(o)}let n=!1;function r(o,a){if(n)return!(n=!1);const s={to:o,options:a,defaultPrevented:!1,preventDefault:()=>s.defaultPrevented=!0};for(const c of t)c.listener({...s,from:c.location,retry:f=>{f&&(n=!0),c.navigate(o,{...a,resolve:!1})}});return!s.defaultPrevented}return{subscribe:e,confirm:r}}let G;function ye(){(!window.history.state||window.history.state._depth==null)&&window.history.replaceState({...window.history.state,_depth:window.history.length-1},""),G=window.history.state._depth}R||ye();function en(t){return{...t,_depth:window.history.state&&window.history.state._depth}}function tn(t,e){let n=!1;return()=>{const r=G;ye();const o=r==null?null:G-r;if(n){n=!1;return}o&&e(o)?(n=!0,window.history.go(-o)):t()}}const Rt=/^(?:[a-z0-9]+:)?\/\//i,vt=/^\/+|(\/)\/+$/g,xt="http://sr";function q(t,e=!1){const n=t.replace(vt,"$1");return n?e||/^[?#]/.test(n)?n:"/"+n:""}function M(t,e,n){if(Rt.test(e))return;const r=q(t),o=n&&q(n);let a="";return!o||e.startsWith("/")?a=r:o.toLowerCase().indexOf(r.toLowerCase())!==0?a=r+o:a=o,(a||"/")+q(e,!a)}function bt(t,e){if(t==null)throw new Error(e);return t}function Ct(t,e){return q(t).replace(/\/*(\*.*)?$/g,"")+q(e)}function me(t){const e={};return t.searchParams.forEach((n,r)=>{e[r]=n}),e}function St(t,e,n){const[r,o]=t.split("/*",2),a=r.split("/").filter(Boolean),s=a.length;return c=>{const f=c.split("/").filter(Boolean),d=f.length-s;if(d<0||d>0&&o===void 0&&!e)return null;const u={path:s?"":"/",params:{}},i=y=>n===void 0?void 0:n[y];for(let y=0;y<s;y++){const h=a[y],m=h[0]===":",p=m?f[y]:f[y].toLowerCase(),w=m?h.slice(1):h.toLowerCase();if(m&&N(p,i(w)))u.params[w]=p;else if(m||!N(p,w))return null;u.path+=`/${p}`}if(o){const y=d?f.slice(-d).join("/"):"";if(N(y,i(o)))u.params[o]=y;else return null}return u}}function N(t,e){const n=r=>r===t;return e===void 0?!0:typeof e=="string"?n(e):typeof e=="function"?e(t):Array.isArray(e)?e.some(n):e instanceof RegExp?e.test(t):!1}function Et(t){const[e,n]=t.pattern.split("/*",2),r=e.split("/").filter(Boolean);return r.reduce((o,a)=>o+(a.startsWith(":")?2:3),r.length-(n===void 0?0:1))}function we(t){const e=new Map,n=ie();return new Proxy({},{get(r,o){return e.has(o)||ue(n,()=>e.set(o,P(()=>t()[o]))),e.get(o)()},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},ownKeys(){return Reflect.ownKeys(t())}})}function Re(t){let e=/(\/?\:[^\/]+)\?/.exec(t);if(!e)return[t];let n=t.slice(0,e.index),r=t.slice(e.index+e[0].length);const o=[n,n+=e[1]];for(;e=/^(\/\:[^\/]+)\?/.exec(r);)o.push(n+=e[1]),r=r.slice(e[0].length);return Re(r).reduce((a,s)=>[...a,...o.map(c=>c+s)],[])}const Pt=100,At=le(),_t=le(),Ht=()=>bt(fe(At),"<A> and 'use' router primitives can be only used inside a Route."),Ot=()=>Ht().navigatorFactory();function Tt(t,e=""){const{component:n,preload:r,load:o,children:a,info:s}=t,c=!a||Array.isArray(a)&&!a.length,f={key:t,component:n,preload:r||o,info:s};return ve(t.path).reduce((d,u)=>{for(const i of Re(u)){const y=Ct(e,i);let h=c?y:y.split("/*",1)[0];h=h.split("/").map(m=>m.startsWith(":")||m.startsWith("*")?m:encodeURIComponent(m)).join("/"),d.push({...f,originalPath:u,pattern:h,matcher:St(h,!c,t.matchFilters)})}return d},[])}function qt(t,e=0){return{routes:t,score:Et(t[t.length-1])*1e4-e,matcher(n){const r=[];for(let o=t.length-1;o>=0;o--){const a=t[o],s=a.matcher(n);if(!s)return null;r.unshift({...s,route:a})}return r}}}function ve(t){return Array.isArray(t)?t:[t]}function Lt(t,e="",n=[],r=[]){const o=ve(t);for(let a=0,s=o.length;a<s;a++){const c=o[a];if(c&&typeof c=="object"){c.hasOwnProperty("path")||(c.path="");const f=Tt(c,e);for(const d of f){n.push(d);const u=Array.isArray(c.children)&&c.children.length===0;if(c.children&&!u)Lt(c.children,d.pattern,n,r);else{const i=qt([...n],r.length);r.push(i)}n.pop()}}}return n.length?r:r.sort((a,s)=>s.score-a.score)}function K(t,e){for(let n=0,r=t.length;n<r;n++){const o=t[n].matcher(e);if(o)return o}return[]}function $t(t,e){const n=new URL(xt),r=P(f=>{const d=t();try{return new URL(d,n)}catch{return console.error(`Invalid path ${d}`),f}},n,{equals:(f,d)=>f.href===d.href}),o=P(()=>r().pathname),a=P(()=>r().search,!0),s=P(()=>r().hash),c=()=>"";return{get pathname(){return o()},get search(){return a()},get hash(){return s()},get state(){return e()},get key(){return c()},query:we(he(a,()=>me(r())))}}let E;function kt(){return E}let T=!1;function Ft(){return T}function nn(t){T=t}function rn(t,e,n,r={}){const{signal:[o,a],utils:s={}}=t,c=s.parsePath||(l=>l),f=s.renderPath||(l=>l),d=s.beforeLeave||wt(),u=M("",r.base||"");if(u===void 0)throw new Error(`${u} is not a valid base path`);u&&!o().value&&a({value:u,replace:!0,scroll:!1});const[i,y]=O(!1);let h;const m=(l,g)=>{g.value===p()&&g.state===x()||(h===void 0&&y(!0),E=l,h=g,W(()=>{h===g&&(w(h.value),L(h.state),Ke(),R||Q[1]([]))}).finally(()=>{h===g&&ze(()=>{E=void 0,l==="navigate"&&Ee(h),y(!1),h=void 0})}))},[p,w]=O(o().value),[x,L]=O(o().state),$=$t(p,x),k=[],Q=O(R?Ae():[]),V=P(()=>typeof r.transformUrl=="function"?K(e(),r.transformUrl($.pathname)):K(e(),$.pathname)),be=we(()=>{const l=V(),g={};for(let b=0;b<l.length;b++)Object.assign(g,l[b].params);return g}),Y={pattern:u,path:()=>u,outlet:()=>null,resolvePath(l){return M(u,l)}};return Ne(he(o,l=>m("native",l),{defer:!0})),{base:Y,location:$,params:be,isRouting:i,renderPath:f,parsePath:c,navigatorFactory:Se,matches:V,beforeLeave:d,preloadRoute:Pe,singleFlight:r.singleFlight===void 0?!0:r.singleFlight,submissions:Q};function Ce(l,g,b){Ge(()=>{if(typeof g=="number"){g&&(s.go?s.go(g):console.warn("Router integration does not support relative routing"));return}const F=!g||g[0]==="?",{replace:j,resolve:A,scroll:I,state:_}={replace:!1,resolve:!F,scroll:!0,...b},H=A?l.resolvePath(g):M(F&&$.pathname||"",g);if(H===void 0)throw new Error(`Path '${g}' is not a routable path`);if(k.length>=Pt)throw new Error("Too many redirects");const Z=p();if(H!==Z||_!==x())if(R){const ee=C();ee&&(ee.response={status:302,headers:new Headers({Location:H})}),a({value:H,replace:j,scroll:I,state:_})}else d.confirm(H,b)&&(k.push({value:Z,replace:j,scroll:I,state:x()}),m("navigate",{value:H,state:_}))})}function Se(l){return l=l||fe(_t)||Y,(g,b)=>Ce(l,g,b)}function Ee(l){const g=k[0];g&&(a({...l,replace:g.replace,scroll:g.scroll}),k.length=0)}function Pe(l,g={}){const b=K(e(),l.pathname),F=E;E="preload";for(let j in b){const{route:A,params:I}=b[j];A.component&&A.component.preload&&A.component.preload();const{preload:_}=A;T=!0,g.preloadData&&_&&ue(n(),()=>_({params:I,location:{pathname:l.pathname,search:l.search,hash:l.hash,query:me(l),state:null,key:""},intent:"preload"})),T=!1}E=F}function Ae(){const l=C();return l&&l.router&&l.router.submission?[l.router.submission]:[]}}function on(t,e,n,r){const{base:o,location:a,params:s}=t,{pattern:c,component:f,preload:d}=r().route,u=P(()=>r().path);f&&f.preload&&f.preload(),T=!0;const i=d?d({params:s,location:a,intent:E||"initial"}):void 0;return T=!1,{parent:e,pattern:c,path:u,outlet:()=>f?Je(f,{params:s,location:a,data:i,get children(){return n()}}):n(),resolvePath(h){return M(o.path(),h,u())}}}const jt="Location",It=5e3,Ut=18e4;let J=new Map;R||setInterval(()=>{const t=Date.now();for(let[e,n]of J.entries())!n[3].count&&t-n[0]>Ut&&J.delete(e)},3e5);function X(){if(!R)return J;const t=C();if(!t)throw new Error("Cannot find cache context");return(t.router||(t.router={})).cache||(t.router.cache=new Map)}function xe(t,e){t.GET&&(t=t.GET);const n=(...r)=>{const o=X(),a=kt(),s=Ft(),f=ie()?Ot():void 0,d=Date.now(),u=e+ce(r);let i=o.get(u),y;if(R){const p=C();if(p){const w=(p.router||(p.router={})).dataOnly;if(w){const x=p&&(p.router.data||(p.router.data={}));if(x&&u in x)return x[u];if(Array.isArray(w)&&!Wt(u,w))return x[u]=void 0,Promise.resolve()}}}if(Xe()&&!R&&(y=!0,Qe(()=>i[3].count--)),i&&i[0]&&(R||a==="native"||i[3].count||Date.now()-i[0]<It)){y&&(i[3].count++,i[3][0]()),i[2]==="preload"&&a!=="preload"&&(i[0]=d);let p=i[1];return a!=="preload"&&(p="then"in i[1]?i[1].then(m(!1),m(!0)):m(!1)(i[1]),!R&&a==="navigate"&&W(()=>i[3][1](i[0]))),s&&"then"in p&&p.catch(()=>{}),p}let h=!R&&S.context&&S.has(u)?S.load(u):t(...r);if(i?(i[0]=d,i[1]=h,i[2]=a,!R&&a==="navigate"&&W(()=>i[3][1](i[0]))):(o.set(u,i=[d,h,a,O(d)]),i[3].count=0),y&&(i[3].count++,i[3][0]()),R){const p=C();if(p&&p.router.dataOnly)return p.router.data[u]=h}if(a!=="preload"&&(h="then"in h?h.then(m(!1),m(!0)):m(!1)(h)),s&&"then"in h&&h.catch(()=>{}),R&&S.context&&S.context.async&&!S.context.noHydrate){const p=C();(!p||!p.serverOnly)&&S.context.serialize(u,h)}return h;function m(p){return async w=>{if(w instanceof Response){const x=w.headers.get(jt);if(x!==null){if(f&&x.startsWith("/"))W(()=>{f(x,{replace:!0})});else if(!R)window.location.href=x;else if(R){const L=C();L&&(L.response={status:302,headers:new Headers({Location:x})})}return}w.customBody&&(w=await w.customBody())}if(p)throw w;return w}}};return n.keyFor=(...r)=>e+ce(r),n.key=e,n}xe.set=(t,e)=>{const n=X(),r=Date.now();let o=n.get(t);o?(o[0]=r,o[1]=e,o[2]="preload"):(n.set(t,o=[r,e,,O(r)]),o[3].count=0)};xe.clear=()=>X().clear();function Wt(t,e){for(let n of e)if(t.startsWith(n))return!0;return!1}function ce(t){return JSON.stringify(t,(e,n)=>Mt(n)?Object.keys(n).sort().reduce((r,o)=>(r[o]=n[o],r),{}):n)}function Mt(t){let e;return t!=null&&typeof t=="object"&&(!(e=Object.getPrototypeOf(t))||e===Object.prototype)}export{At as R,Vt as a,oe as b,Xt as c,gt as d,xe as e,Zt as f,Gt as g,Qt as h,et as i,Lt as j,rn as k,on as l,Yt as m,_t as n,K as o,kt as p,nn as q,xt as r,Jt as s,en as t,ye as u,wt as v,tn as w};
